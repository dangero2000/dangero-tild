name: Deploy Hugo site to tilde

on:
  push:
    branches: ["main"]

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Install deploy dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends rsync openssh-client coreutils ca-certificates
          rsync --version
          ssh -V

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: "latest"
          extended: true

      - name: Build
        run: hugo --minify --baseURL "https://lowerelements.club/~dangero/"

      - name: Add SSH known_hosts
        env:
          HOST: ${{ secrets.TILDE_HOST }}
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          ssh-keyscan -H "$HOST" >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

      - name: Deploy via rsync
        shell: bash
        env:
          KEY_B64: ${{ secrets.TILDE_SSH_KEY_B64 }}
          HOST: ${{ secrets.TILDE_HOST }}
          USER: ${{ secrets.TILDE_USER }}
          REMOTE_PATH: ${{ secrets.TILDE_PATH }}
        run: |
          set -euo pipefail

          umask 077

          # Decode key from base64 to avoid newline/format corruption in secrets
          printf '%s' "$KEY_B64" | base64 -d > /tmp/deploy_key
          chmod 600 /tmp/deploy_key

          # Quick sanity check that the key parses
          ssh-keygen -y -f /tmp/deploy_key >/dev/null

          # SSH options we will reuse everywhere
          SSH_OPTS="-i /tmp/deploy_key -o IdentitiesOnly=yes -o BatchMode=yes -o StrictHostKeyChecking=yes"

          # Optional: sanity check remote has rsync (fails fast with a useful error)
          ssh $SSH_OPTS "${USER}@${HOST}" 'command -v rsync >/dev/null && rsync --version'

          # Ensure destination exists
          ssh $SSH_OPTS "${USER}@${HOST}" "mkdir -p '${REMOTE_PATH}'"

          # Deploy (verbose SSH so we can see why it drops; avoid leaking secrets)
          RSYNC_RSH="ssh $SSH_OPTS -vvv"
          rsync -rlgoDzvc --delete \
            -e "$RSYNC_RSH" \
            public/ \
            "${USER}@${HOST}:${REMOTE_PATH}/"
